<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="http://code.jquery.com/jquery-1.8.3.js"></script>
    <script>
        let users = [];
        let ws;
        let canvas;

        let timerId;
        let throttleFunction = function (func, delay, arg) {
            // If setTimeout is already scheduled, no need to do anything
            if (timerId) {
                return
            }

            // Schedule a setTimeout after delay seconds
            timerId = setTimeout(function () {
                func(arg);

                // Once setTimeout function execution is finished, timerId = undefined so that in <br>
                // the next scroll event function execution can be scheduled by the setTimeout
                timerId = undefined;
            }, delay)
        };

        function move (event) {
            const keyName = event.key;
            let vertical = 0;
            let horizontal = 0;
            if (keyName === "w") {
                vertical = -1;
            }
            if (keyName === "s") {
                vertical = 1;
            }
            if (keyName === "d") {
                horizontal = 1;
            }
            if (keyName === "a") {
                horizontal = -1;
            }
            ws.send(JSON.stringify({type: "move", data: {horizontal: horizontal, vertical: vertical}}));
        }

        function openWS() {
            ws = new WebSocket("ws://0.0.0.0:8000?user=" + $('#nick').val());
            $('#main_block').show();
            $('#login_form').hide();
            canvas = document.getElementById('canvas');
            document.addEventListener('keypress', (event)=>{throttleFunction(move, 100, event)});
            ws.onmessage = function (evt) {
                let data = JSON.parse(evt.data);
                if (data.type === "message") {
                    $('#div').append("<div style='border: 1px solid red'>author: " + data.author + "<br>message: " + data.data + "</div>");
                } else if (data.type === "users") {
                    users = data.data;
                    let ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    for (let i = 0; i < users.length; i++) {
                        ctx.fillStyle = "rgb(" +
                            users[i].color.r + ", " +
                            users[i].color.g + ", " +
                            users[i].color.b +
                            ")";
                        ctx.font = "30px Arial";
                        ctx.fillRect(users[i].coordinates.x - 25, users[i].coordinates.y - 25, 50, 50);
                        ctx.fillStyle = "black";
                        ctx.fillText(users[i].login, users[i].coordinates.x - 25, users[i].coordinates.y - 25);

                    }
                    console.log(users);
                }
            };
        }

        $(document).ready(function () {
        });
    </script>
    <meta charset="UTF-8">
    <title>socket</title>
</head>
<body>
<div id="login_form">
    <label>Введи никнейм
        <input id="nick"/>
    </label>
    <button id="connect" onclick="openWS()">connect</button>
</div>
<div id="main_block" style="display: none">
    <canvas id="canvas" width="1000" height="1000"></canvas>
</div>
</body>
</html>
