<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="http://code.jquery.com/jquery-1.8.3.js"></script>
    <script src="/User.js"></script>
    <script src="/Player.js"></script>
    <script>
        let users = [];
        let player = null;
        let ws;
        let canvas;
        let time = 0;

        function press(event, type) {
            const keyName = event.code;
            if (keyName === "KeyW") {
                player.vertical = (type ? -1 : 0);
            }
            if (keyName === "KeyS") {
                player.vertical = (type ? 1 : 0);
            }
            if (keyName === "KeyD") {
                player.horizontal = (type ? 1 : 0);
            }
            if (keyName === "KeyA") {
                player.horizontal = type ? -1 : 0;
            }
        }


        function attack(event) {
            if(event.button === 0){
                let x = event.clientX + document.body.scrollLeft +
                    document.documentElement.scrollLeft;
                let y = event.clientY + document.body.scrollTop +
                    document.documentElement.scrollTop;
                x -= canvas.offsetLeft;
                y -= canvas.offsetTop;
                player.attack(x, y);
            }
        }

        function openWS() {
            ws = new WebSocket("ws://0.0.0.0:8000?user=" + $('#nick').val());
            $('#main_block').show();
            $('#login_form').hide();
            canvas = document.getElementById('canvas');
            ws.onmessage = function (evt) {
                let data = JSON.parse(evt.data);
                if (data.type === "users") {
                    users = [];
                    time = data.time;
                    for (let i=0; i < data.data.length; i++){
                        if($('#nick').val() === data.data[i].login){
                            if(player){
                                player.update(data.data[i]);
                            }else{
                                player = new Player(data.data[i], ws);
                                document.addEventListener('keydown', (event) => {
                                    press(event, true);
                                });
                                document.addEventListener('keyup', (event) => {
                                    press(event, false);
                                });
                                canvas.addEventListener('mousedown', attack);
                                setInterval(() => {
                                    player.work();
                                }, 50);
                            }
                        }else{
                            users.push(new User(data.data[i]));
                        }
                    }
                    let ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    for (let i = 0; i < users.length; i++) {
                        users[i].draw(ctx);
                    }
                    player.draw(ctx, time);
                }
            };
        }

        $(document).ready(function () {
        });
    </script>
    <meta charset="UTF-8">
    <title>socket</title>
</head>
<body>
<div id="login_form">
    <label>Введи никнейм
        <input id="nick"/>
    </label>
    <button id="connect" onclick="openWS()">connect</button>
</div>
<div id="main_block" style="display: none">
    <canvas id="canvas" width="1000" height="1000"></canvas>
</div>
</body>
</html>
